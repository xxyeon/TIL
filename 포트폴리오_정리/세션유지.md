# jwt

문제

1. 디코딩이 쉽다 -> 개인정보 넣으면 안됨.
2. stateless이므로 토큰 유효 여부만 확인 하고 통과, 탈취 여부 확인을 못함
3. 시크릿키를 예측하지 못하도록 길게 설정, 잘못 설정하면 누구나 시크릿키를 이용해서 서버에 통과할수 있는 jwt 생성 가능 (HMAC 방식임 -> 서버의 개인키를 알 고 있다면 누군든지 서명 생성할 수 있다는 뜻)
4. 헤더에 alog값을 none으로 설명하면 안된다. 페이로드 암호화 방식을 설정해주지 않았음 ->none 으로 하면 서명 없이도 인증 가능하게 만드는 것이므로 심각한 취약점이다.
   만약 서버가 alg: none을 허용하면,

누구나 서명 없는 JWT를 위조해서 사용할 수 있음.

이건 인증을 우회할 수 있는 중대한 보안 취약점입니다.

✅ 즉, alg 값을 none으로 설정한 후 서명 없는 토큰을 보내도 서버가 검증 없이 통과시킨다면 인증 시스템이 무력화됩니다.

로그인 하면 우리가 설정한 암호화 알고리즘을 지정해준다 -> algo 강제로 설정해서 클라이언트에게 전달
만일 클라이언트가 토큰을 보내다가 탈취 당해서 algo:none으로 설정해서 보내면? 어떻게 되는가?
서버에서 algo 값을 검증하는 로직을 추가 -> 클라이언트가 algo:none으로 보내도 서버는 HS256 서명 검증을 시도하고, 서명이 없으므로 검증 실패(401 Unauthorized)

취약한 서버라면 algo 값만 보고 none이면 검증을 건너 뛰는 경우 -> 공격자는 서명 없이 임의의 토큰으로 인증 우회 가능함

```java
JWT.require(Alorithm.HMACC256(secret)).build().verify(token);
```

절대 클라이언트가 보낸 algo 를 신뢰하지 말것
alg는 JWT의 서명을 어떤 알고리즘으로 검증할지 서버에게 알리는 힌트이자 메타정보입니다.

# 쿠키

쿠키 특징

이름, 값, 만료일(저장기간), 경로 정보로 구성되어 있다.
클라이언트에 총 300개의 쿠키를 저장할 수 있다.
하나의 도메인 당 20개의 쿠키를 가질 수 있다.
하나의 쿠키는 4KB(=4096byte)까지 저장 가능하다.

쿠키의 동작 순서

클라이언트가 페이지를 요청한다. (사용자가 웹사이트에 접근)
웹 서버는 쿠키를 생성한다.
생성한 쿠키에 정보를 담아 HTTP 화면을 돌려줄 때, 같이 클라이언트에게 돌려준다.
넘겨받은 쿠키는 클라이언트가 가지고 있다가(로컬 PC에 저장) 다시 서버에 요청할 때 요청과 함께 쿠키를 전송한다.
동일 사이트 재방문 시 클라이언트의 PC에 해당 쿠키가 있는 경우, 요청 페이지와 함께 쿠키를 전송한다.

사용 예시

방문 사이트에서 로그인 시, "아이디와 비밀번호를 저장하시겠습니까?"
팝업창을 통해 "오늘 이 창을 다시 보지 않기" 체크

## persistent cookie 세션 유지 확인하기(크롬기준)

### 일반모드에서

1. 새로운 창에서 로그인 -> 해당 창에서 새로운 탭 (유지)
2. 새로운 창에서 로그인 -> 해당 창 닫지 않고 새로운 창(유지)
3. 새로운 창에서 로그인 -> 해당 창 닫고 새로운 창(유지 안됨) -> 유지 되는게 정상아닌가? (브라우저 프로세스가 완전히 종료 -> 세션 스토리지도 없어짐, 새로운 창을 띄우면 새로운 httpd 로 실행됨) 유지는 된다. 하지ㅏㅁㄴ 서버에서 문제였다.

### 시크릿 모드에서

1. 새로운 창에서 로그인 -> 해당 창에서 새로운 탭(유지)
2. 새로운 창에서 로그인 -> 해당 창 닫지 않고 새로운 창 (유지)
3. 새로운 창에서 로그인 -> 로그인한 창 닫고, 새로운 창 생성해서 요청(유지X) -> 웹 브라우저 프로세스가 로그인 세션이 저장된 프로세스 종료 후 새로운 프로세스 실행되었으므로 세션이 없음

## Session Cookie, Persistent Cookie

여태까지 쿠키는 만료일자를 정해주면 만료일자 동안 계속 쿠키게 값이 영구 저장된다고 알고 있었다.  
찾아보니 Session Cookie와 Persistent Cookie가 있다는 것을 알게 되었다...

[쿠키의 Expires를 지정하지 않으면 쿠키는 세션 쿠키가 된다.](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Set-Cookie#expiresdate) 클라이언트가 종료되면 세션이 종료되고, 그 후 세션 쿠키는 제거됩니다.(웹 브라우저를 종료하면 세션 쿠키는 삭제된다.)

> 많은 웹 브라우저는 모든 탭을 저장하고 다음에 브라우저를 사용할 때 복원하는 세션 복원 기능이 있습니다. 브라우저를 복원하면 세션 쿠키도 브라우저를 닫지 않은 것처럼 복원될 수 있습니다.
> 쿠키는 사용자 계정과 같은 장기적인 정보/값을 저장해야 할 때 선호됩니다. (사용자가 컴퓨터를 2일 동안 종료하더라도 계정은 계속 로그인된 상태로 유지됩니다.)

```
대부분의 프레임워크에는 세션 미들웨어가 있습니다. 사용자 권한을 부여하려면 사용자 ID(가급적 UUID 등)만 설정하면 되고, 서명만 되어 있으면 그 외에는 아무것도 할 필요가 없습니다. 각 요청에서 사용자 권한을 부여하는 것 외에 세션을 실제로 사용하는 경우 세션 ID와 테이블을 사용합니다
```

세션 id를 넘겨줄 때도 암호화해서 넘겨주어야함. 서버에서 저장하는 세션 ID는 사용자 개인정보를 찾기 위한 고유값이고, 이 고유값을 클라이언트가 마음대로 조정해서 요청했을때 다른 고유값과 일치하게되며 문제가 됨 -> 그래서 해시 함수로 세션 id를 만들고, 이 해시값을 세션 id로 만드는것이 안전?

### 세션 쿠키에 여러 브라우저를 사용할 때 세션이 유지되는 이유

로그인 한 브라우저 창을 닫지 않고 여러 브라우저로 요청을 했을 때 세션이 유지가 된다. 그 이유는 무엇을까?
브라우저 세션/스토리지는 사용자 계정 기반으로 공유되는 영역이다.  
브라우저 창을 별도의 프로세스이지만 브라우저는 여러 창과 탭이 있어도, "사용자 프로필" 단위로 세션/쿠키를 관리한다.

### 크롬 일반 창, 시크릿 창

전제: 스프링 HttpSession을 통해서 세션 구현

- 시크릿 모드: 시크릿 모드에서도 시크릿 세션 컨텍스트(공유역역)을 사용한다. -> 임시 세션을 시크릿 프로세스가 모두 공유한다.
  새 시크릿 창 생성 후 로그인하고 해당 창에서 새로운 시크릿 "탭"을 생성하면 로그인 유지, 새로운 "창"을 생성하여도 쿠키/세션값은 남아 있음. 마찬가지로 새로운 창을 열어도 세션은 남아 있음. (로그인한 시크릿 브라우저가 열려 있다는 전제하에)

- 일반 모드: 브라우저 프로세스가 "사용자 프로필 기반"으로 세션, 쿠키를 공유하므로 새로운 창을 생성해도 "사용자 프로필이 동일"하다면 동일한 세션/쿠키를 사용하므로 로그인이 유지된다.

HttpSession은 요청마다 생성된다. -> 요청이 다르면 세션도 새롭게 생성 -> 로그인한 브라우저 닫고 새 창으로 요청하면 새로운 요청이다

- WAS에서 JSESSIONID 쿠키에 따라 세션을 구분하므로 이 세션이 달라지면 HttpSession 도 별개의 공간으로 세션을 생성한다는 말이다.

## remember ME 기능은 어떻게 구현되는가?

Remember-me 데이터는 쿠키에 저장해야 합니다. 그렇지 않으면 사용자가 브라우저를 닫을 때 데이터가 손실됩니다. 하지만 'Remember-me' 쿠키에 비밀번호나 사용자 개인 정보를 저장하지 마세요. 사용자 데이터를 데이터베이스에 저장하고, 이 데이터를 쿠키에 저장된 암호화된 ID/키 쌍과 연결하세요.

이전 권장 사항을 고려한 후, 결국 쿠키와 세션 중 무엇을 선택해야 할지 고민하게 됩니다.

사용자가 브라우저를 닫아도 영구 데이터는 남아 있어야 합니까?

만약 대답이 '예' 라면 , 쿠키를 사용하세요 .
만약 대답이 '아니요' 라면 세션을 사용하세요 .

쿠키의 expire값을 정해주면 remember me로 사용하는 거고, session cookie라면 세션 동안에만(브라우저가 열려있는 동안) 세션이 유지된다. 그래서 "로그인 정보를 기억" 이라는 옵션을 따로 둬서 쿠키를 유지할 것인지 여부를 묻는것이 좋다고 한다.

### jwt도 이렇게 구현할 수있는가?

리프레시를 발급해주고 자동으로 로그인하도록 구현했는데 이건 무조건 로그인 정보를 기억하는 것일까?
클라리언트가 어떻게 설정하느냐에 따라 달려있다. 쿠키에 리프레시 토큰은 session cookie로 설정하느냐 마느냐...

참고 자료

- https://stackoverflow.com/questions/6253633/advantages-disadvantages-of-using-cookies-to-store-a-user-id
- https://stackoverflow.com/questions/34870747/session-cookie-vs-persistent-cookie
- [쿠키의 만료시간 설정](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Set-Cookie#expiresdate)
- [쿠키의 동작 순서](https://dev-coco.tistory.com/61)
