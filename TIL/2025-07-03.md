# 핫스팟의 가비지 수집

## TLAB(Thread Local Allocation Buffer)

TLAB란 새로운 객체가 생성되면 에덴 영역에 할당되는데, JVM이 에덴 영역을 여러 버퍼로 나눠 애플리케이션 스레드가 새 객체를 할당하는 구역으로 활용하여 배포한다. 이렇게 에덴 영역을 스레드 별로 관리해줄 수 있도록하는 버퍼이다.

## 반구형 수집

반구형(방출)수집기는 두개의 공간을 사용하여, 장수하지 못하는 객체를 임시로 저장하는 장소로 사용된다. 장수하지 못하는 객체인데 바로 테뉴어드 공간으로 승격하면 테뉴어드 공간만 차지하게 되기 때문에 중간 저장소를 만든 것이다.

이 두 공간은 다음과 같은 특성을 지닌다.

1. 수집기가 라이브 반구를 수집할 때 객체들은 다른 반구로 압착시켜 옮기고 수집된 반구는 비워서 재사용한다.
2. 절반의 공간을 항상 비어 있어야한다.

핫스팟은 이 반구형 기법과 에덴 공간을 접목시켜 영 세대를 수집 -> 서바이버라고 부른다.

## 병렬 수집기

자바 8 이전까지 JVM 디폴트 가비지 수집기는 병렬 수집기였다. 병렬 수집기는 youn GC, full GC 모두 STW를 발생하고, 애플리케이션 스레드를 모두 정지 후 가용 cpu 코어를 총동원하여 가능한 빨리 메모리를 수집한다.

### young 세대 병렬 수집

스레드가 에덴에 객체를 할당하려는데 자신이 할당받은 TLAB 공간은 부족하고 JVM은 새 TLAB를 할당해줄 수 없을 때 발생  
전체 애플리케이션 스레드가 중단되면 핫스팟은 영 세대(에덴 및 비어있지 않은 서바이버 공간)을 뒤져서 가비지 아닌 객체를 골라냅니다. 이때 GC 루트(와 올드 세대에서 출발하는 GC 루트를 식별하기 위한 카드 테이블)을 병렬 마스킹 스캔 작업의 출발점으로 삼는다.  
살아있는 객체만 건드려(GC 루트, 마트 테이블을 출발점으로 bfs하여 탐색) 약한 세대별 가설의 이점을 최대한 활용(단면, old의 참조를 받는 young gen은 거의 없다) -> 살아있는 객체가 거의 없다는 점을 활용하여 STW 시간 단축

### old 세대 병렬 수집

Parallel GC는 객체를 방출하는 반구형 수집기이지만, ParallelOld GC는 하나의 연속된 메모리 공간에서 압착하는 수집기이다.

- 영세대 GC: 영 공간의 점유 상태는 GC 이벤트가 발생할 때마다 메모리 할당 및 소거가 일어나면서 급격하게 변함(단명하는 객체가 대부분 + 새로운 객체에 계속 메모리 할당, 단명 객체에 대한 메모리 소거)
- 올드 세대 GC: GC 이벤트가 잘 발생하지 않음. 큰 객체가 테뉴어드 세대에 직접 생성될 때 + 영 세대 객체가 승격 혹은 올드/풀 수집이 일어나 객체를 재탐색 후 다시 배치하는 등의 수집이 일어날 때만 변함
