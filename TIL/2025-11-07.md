# Spring Data JPA에서 새로운 Entity인지 판단하는 방법

새로운 엔티티인지 여부는 JpaEntityInformation의 `isNew(T entity)`에 의해 판단된다.
다른 설정이 없으면 `JpaInformation` 구현체중 `JpaMetamodelEntityInformation` 클래스가 동작한다. `@Version`이 사용된 필드가 없거나 `@Version`이 사용된 필드가 primitive 타입이면 `AbstratEntityInformation` 의 `isNew()` 를 호출한다.

`@GeneratedValue` 어노테이션으로 키 생성 전략을 사용하면 데이터베이스에 저장될 때 id가 할당된다. 따라서 데이터베이스에 저장되기 전에 메모리에서 생성된 객체는 id가 비어있기 때문에 `isNew()` 는 true 가 되어 새로운 엔티티로 판단된다.

## 직접 ID를 할당하는 경우에는 어떻게 동작?

키 생성 전략을 사용하지 않고 직접 ID를 할당하는 경우 새로운 엔티티로 간주되지 않는다. 이 때 엔티티는 `Persistable<T>` 인터페이스를 구현해서 `JpaMetamodelEntityInformation` 클래스가 아닌 `JpaPersistableEntityInformation`의 `isNew()`가 동작하도록 해야한다.

## 새로운 엔티티인지 판단하는게 왜 중요한가?

SimpleJpaRepository의 `save()` 메서드에서 `isNew()` 를 사용하여 persist를 수행할지 merge를 수행할지 결정한다. 만약 id를 지정해주는 경우에는 신규 엔티티라고 판단하지 않기때문에 merge룰 수행한다. 이때 해당 entity는 신규임에도 불구하고 DB조회가 일어나기 때문에 비효율이 발생한다. 따라서 새로운 엔티티인지 판단하는 것은 중요한 부분이다.

### 다시 공부해볼 점

엔티티 매니저, @GeneratedValue 동작 과정, merge 동작 과정
