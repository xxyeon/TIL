# 언두 로그 목적

MVCC는 언두로그를 이용해 구현한다.
언두로그는 "트랜잭션 보장"과 "격리 수준"을 보장해준다.

1. 트랜잭션 보장: 트랜잭션이 롤백되면 트랜잭션 도중 변경된 데이터를 변경 전 데이터로 복구해야하는데, 이때 언두 로그에 백업해둔 이전 버전의 데이터를 이용해 복구한다.
2. 격리 수준 보장: 특정 커넥션에서 데이터를 변경하는 도중에 다른 커넥션에서 데이터를 조회하면 트랜잭션 격리수준에 맞게 변경 중인 레코드를 읽지 않고 언두 로그에 백업해둔 데이터를 읽어서 반환한다.

언두 로그는 InnoDB 스토리 엔진에서 매우 중요한 역할을 담당하지만 관리 비용도 많이 필요하다고 한다. 언두로그의 문제점과, 이를 위해 InnoDB 스토리 엔진이 어떤 기능을 제공하는지 알아보자.

## 언두 로그 레코드 모니터링

언두 로그의 데이터가 어떻게 저장되고 어떤 목적으로 사용되는지 살펴보자. 언두 영역은 데이터를 변경하는 작업 ISERT, UPDATE, DELETE 등이 발생했을 때 변경되기 전의 데이터(이전 데이터)를 보관하는 곳이다.

```mysql
UPDATE memeber SET name = '홍길동' WHERE member_id=1;
```

위 문장이 실행되면 트랜잭션을 "커밋하지 않아도" 실제 데이터 파일(데이터/인덱스 버퍼) 내용을 '홍길동'으로 변경된다. 그리고 변경되기 전의 값이 '벽계수'였다면, 언두 영역에는 '벽계수'라는 값이 백업되는 것이다. 이 상태에서 커밋하면 현재 상태 유지, 롤백하면 언두 영역의 백업된 데이터를 다시 데이터 파일로 복구한다.  
이처럼 언두 영역은 트랜잭션 롤백용으로 사용된다.

두번째 용도는 트랜잭션 격리 수준을 유지하면서 높은 "동시성"을 제공하는데에 있다.(MVCC가 낙관락의 방법론 중 하나인 이유, 언두 로그를 활용하여 락 없는 동시성 제공)  
트랜잭션의 격리 수준이라는 개념은 동시에 여러 트랜잭션이 데이터를 변경하거나 조회할 때 한 트랜잭션의 작업 내용이 다른 트랜잭션에 어떻게 "보일지"를 결정하는 기준다.  
MySQL 5.5 이전 버전의 MySQL 서버에서는 한번 증가한 언두로그 공간은 다시 줄어들지 않는다. 대용량의 데이터를 처리하는 트랜잭션뿐만 아니라 트랜잭션이 오랜 시간 동안 실행될 때도 언두 로그의 양은 급격히 증가할 수 있다. 이렇게 늘어나는 언두로그는 MySQL 서버를 새로 구축하지 않는 한 줄일 수가 없었다. 언두 로그가 늘어나면 디스크 사용량 뿐만 아니라 매번 백업할 때도 그만큼 더 복사해야하는 문제점이 발생한다.  
MySQL 5.7과 MySQL 8.0으로 업그레드되면서 언두 로그 공간의 문제점은 해결되었다. MySQL 8.0 에서는 언두로그를 돌아가면서 순차적으로 사용해 디스크 공간을 줄이는 것도 가능하며, 때로는 MySQL 서버가 필요한 시점에 사용 공간을 자동으로 줄여주기도 한다.  
하지만 여전히 서비스 중인 MySQL 서버에서 활성 상태의 트랜잭션이 장시간 유지되는 것은 성능상 좋지 않다. 그래서 MySQL 서버의 언두 로그 레코드가 얼마나 되는지 항상 모니터링하는 것이 좋은데, 다음과 같이 MySQL 서버의 언두 로그 레코드 건수를 확인할 수 있다.

```mysql
SHOW EGINE INNODB STATU \G

SELECT count
FROM information_schema.innodb_metrics
WHERE SUBSYSTEM='transaction' AND NAME='trx_rseg_history_len';
```

변경 작업이 얼마나 많이 일어나느냐에 따라 평상시 언두 로그에 존재하는 레코드는 상이하다. 서버별로 안정적인 시점의 언두로그 레코드 건수를 확인해 이를 기준으로 언두 로그의 급증 여부를 모니터링하는 것이 좋다.
